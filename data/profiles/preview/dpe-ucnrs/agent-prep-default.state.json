{
  "_id": "agent-prep-default",
  "source_defaults": {},
  "sources": [
    {
      "description": "UCNRS: Prepare payload for writing to Influx",
      "error_subject": "ucnrs.prep.v1.err.patch",
      "preprocessing_expr": [
        "($org := context.org_slug ~> $safeName;",
        "$station := context.station ~> $safeName;",
        "$table := context.table ~> $safeName;",
        "$tags := ['org' & '$' & $org, 'station' & '$' & $station, 'table' & '$' & $table];",
        "$time := payload.time;",
        "$params := {'tags': $tags, 'time': $time};",
        "$options := {'database': 'station_' & $station, 'precision': 'ms'};",
        "$fields := payload ~> $deleteNulls ~> $deleteKeys(['time']);",
        "$points := [{'fields': $fields, 'measurement': 'source_' & $table, 'time': $time}];",
        "$payload := {'options': $options, 'points': $points};",
        "$ ~> |$|{'params': $params, 'payload': $payload}|;)"
      ],
      "pub_to_subject": "ucnrs.prep.v1.out",
      "sub_options": {
        "ack_wait": 60000,
        "durable_name": "patch"
      },
      "sub_to_subject": "ucnrs.patch.v1.out"
    },
    {
      "description": "UCNRS: Prepare payload for writing to Influx (CSI)",
      "error_subject": "ucnrs.prep.v1.err.patch.csi",
      "preprocessing_expr": [
        "($org := context.org_slug ~> $safeName;",
        "$station := context.station ~> $safeName;",
        "$table := context.table ~> $safeName;",
        "$tags := ['org' & '$' & $org, 'station' & '$' & $station, 'table' & '$' & $table];",
        "$time := payload.time;",
        "$params := {'tags': $tags, 'time': $time};",
        "$options := {'database': 'station_' & $station, 'precision': 'ms'};",
        "$fields := payload ~> $deleteNulls ~> $deleteKeys(['time']);",
        "$points := [{'fields': $fields, 'measurement': 'source_' & $table, 'time': $time}];",
        "$payload := {'options': $options, 'points': $points};",
        "$ ~> |$|{'params': $params, 'payload': $payload}|;)"
      ],
      "pub_to_subject": "ucnrs.prep.v1.out",
      "sub_options": {
        "ack_wait": 60000,
        "durable_name": "patch-csi"
      },
      "sub_to_subject": "ucnrs.patch.v1.out.csi"
    },
    {
      "description": "UCNRS: Prepare payload for writing to Influx (GOES)",
      "error_subject": "ucnrs.prep.v1.err.patch.goes",
      "preprocessing_expr": [
        "($org := context.org_slug ~> $safeName;",
        "$station := context.station ~> $safeName;",
        "$table := context.table ~> $safeName;",
        "$tags := ['org' & '$' & $org, 'station' & '$' & $station, 'table' & '$' & $table];",
        "$time := payload.time;",
        "$params := {'tags': $tags, 'time': $time};",
        "$options := {'database': 'station_' & $station, 'precision': 'ms'};",
        "$fields := payload ~> $deleteNulls ~> $deleteKeys(['time']);",
        "$points := [{'fields': $fields, 'measurement': 'source_' & $table, 'time': $time}];",
        "$payload := {'options': $options, 'points': $points};",
        "$ ~> |$|{'params': $params, 'payload': $payload}|;)"
      ],
      "pub_to_subject": "ucnrs.prep.v1.out",
      "sub_options": {
        "ack_wait": 60000,
        "durable_name": "patch-goes"
      },
      "sub_to_subject": "ucnrs.patch.v1.out.goes"
    }
  ],
  "static_rules": [
    {
      "begins_at": "1500-01-01T00:00:00.000Z",
      "definition": {
        "transform_expr": []
      },
      "ends_before": "1600-01-01T00:00:00.000Z",
      "tags": []
    }
  ]
}