{
  "source_defaults": {
    "queue_group": "archive",
    "sub_options": {
      "ack_wait": 20000,
      "durable_name": "20210405"
    }
  },
  "sources": [
    {
      "description": "CHI: Archive Iridium SBD messages from email",
      "error_subject": "chi.archive.v1.err.import.email.iridium.sbd",
      "preprocessing_expr": [
        "($device := payload.device ~> $safeName;",
        "$table := payload.table ~> $safeName;",
        "$time := payload.envelope.date;",
        "$docId := $join(['chi', 'email', $device, $table, $substring($time, 0, 10), $substring($time, 11, 2), $substring($time, 14, 2)], '-');",
        "$valid := $contains($docId, /^chi-email-\\w+-\\w+-\\d{4}-\\d{2}-\\d{2}-\\d{2}-\\d{2}$/);",
        "$params := $valid ? {'document_id': $docId} : {};",
        "$ ~> |$|{'params': $params}|;)"
      ],
      "sub_to_subject": "chi.import.v1.out.email.iridium.sbd"
    }
  ]
}