{
    "source_defaults":
    {
        "queue_group": "prep",
        "sub_options":
        {
            "ack_wait": 60000,
            "durable_name": "20220614"
        }
    },
    "sources":
    [
        {
            "description": "CHI: Prepare patched payload for writing to Influx",
            "error_subject": "chi.prep.v1.err.patch",
            "preprocessing_expr":
            [
                "($org := context.org_slug ~> $safeName;",
                "$station := context.station ~> $safeName;",
                "$device := context.device ~> $safeName;",
                "$table := context.table ~> $safeName;",
                "$tags := [];",
                "$time := payload.time;",
                "$params := {'tags': $tags, 'time': $time};",
                "$database := $station ? 'station_' & $station : $device ? 'device_' & $device : 'database_unknown';",
                "$options := {'database': $database, 'precision': 'ms'};",
                "$fields := payload ~> $deleteNulls ~> $deleteKeys(['time']);",
                "$points := [{'fields': $fields, 'measurement': 'source_' & $table, 'time': $time}];",
                "$payload := {'options': $options, 'points': $points};",
                "$ ~> |$|{'params': $params, 'payload': $payload}|;)"
            ],
            "pub_to_subject": "chi.prep.v1.out",
            "sub_to_subject": "chi.patch.v1.out"
        },
        {
            "description": "CHI: Prepare GOES OTT ASCII Column data for writing to Influx",
            "error_subject": "chi.prep.v1.err.goes.ott.asciiColumn",
            "preprocessing_expr":
            [
                "($org := context.org_slug ~> $safeName;",
                "$station := context.station ~> $safeName;",
                "$table := context.table ~> $safeName;",
                "$tags := ['org' & '$' & $org, 'source$goes_ott_ascii_column', 'station' & '$' & $station, 'table' & '$' & $table];",
                "$time := payload.header.timeDate;",
                "$params := {'tags': $tags, 'time': $time};",
                "$options := {'database': 'station_' & $station, 'precision': 'ms'};",
                "$chars := {'10':'\n','13':'\r','32':' ','34':'','46':'.','48':'0','49':'1','50':'2','51':'3','52':'4','53':'5','54':'6','55':'7','56':'8','57':'9'};",
                "$data := $reduce(payload.body.data, function($d, $v) { $d & ($lookup($chars,$string($v)) ?? '?')}, '');",
                "$lines := $data  ~> $split('\r\n') ~> $map($trim) ~> $filter($length);",
                "$points := $lines ~> $map(function($line) { {'values': $split($line, ' ') ~> $map($number), 'measurement': 'source_' & $table} });",
                "$payload := {'options': $options, 'points': $points};",
                "$ ~> |$|{'params': $params, 'payload': $payload}|;)"
            ],
            "pub_to_subject": "chi.prep.v1.out",
            "sub_to_subject": "chi.import.v1.out.goes.ott.asciiColumn"
        }
    ],
    "static_rules":
    [
        {
            "begins_at": "2000-01-01T00:00:00.000Z",
            "definition":
            {
                "transform_expr":
                [
                    "($points := $map(points, function($p, $i) {{",
                    "'fields': {",
                    "'Feet': $p.values[0],",
                    "'Fahrenheit': $p.values[1],",
                    "'Volts': $p.values[2]},",
                    "'measurement': $p.measurement,",
                    "'time': $time().startOf('h').add($i * -15, 'm').toMillis()",
                    "}});",
                    "$ ~> |$|{'points': $points}|;)"
                ]
            },
            "ends_before": "2100-01-01T00:00:00.000Z",
            "tags":
            [
                "org$chi",
                "source$goes_ott_ascii_column",
                "station$cw3e_dac",
                "table$ottable"
            ]
        }
    ]
}